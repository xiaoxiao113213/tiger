import{F as e,r as i,O as t,j as a,I as l,R as s,S as n,B as d,c as r,Y as p,m as u,am as o}from"./index-03adb9ee.js";import{getStep as m,getStage as c}from"./index-7ad95df9.js";import{pipelinePluginDetailAllApi as f,pipelinePluginAllApi as j,pipelinePluginDetailGetOneApi as h}from"./api-8691a2b8.js";import{clientToServerValueItem as x,serverToClientValue as g}from"./Bo-c1a8a5bb.js";import{usePipelineContext as S}from"./context-3c44e91e.js";import{C as I}from"./index-173fa263.js";import y from"./submitNowform-fbdcf9ab.js";import{C as b}from"./index-3585a1a3.js";import"./textSubmit-bd6c5b40.js";import"./textAreaSubmit-3b52d66b.js";import"./SelectSubmit-4c180fb2.js";import"./MutSelectSubmit-064a257d.js";import"./DateSubmit-95284b79.js";import"./NumberSubmit-77884c9b.js";import"./FileUploadSubmit-e8f92bb2.js";import"./PlusOutlined-b4032aa8.js";const v=v=>{const[F]=e.useForm(),[P,N]=i.useState(0),[C,L]=i.useState(0),[w,D]=i.useState(),[O,V]=i.useState([]),[T,k]=i.useState([]),[q,E]=i.useState([]),{pipelineOpenType:B}=S(),[G,J]=i.useState(""),[R,A]=i.useState(!0),[M,U]=i.useState(0),[Y]=e.useForm(),$=(e,i)=>{J(e),B===t.detail?A(!0):A(i),U((e=>e+1))},z=async e=>{let i=await h({pipelinePluginDetailId:e});if(r(i))return null;let a=i.data.params.filter((e=>0===e.scope));v.stepComponentOpenType!==t.add&&a.forEach((e=>{let i=w?.paramList.find((i=>e.keyName===i.keyName));i&&(e.value=i.value)})),a.forEach((e=>{g(e)})),E(a);const l={};a.forEach((e=>{l[e.id]=e.value})),Y?.setFieldsValue(l)},H=async(e,i)=>{N(parseInt(e));let t=await f({pipelinePluginId:e});if(r(t))return null;if(k(t.data),t.data.length>0){let a=t.data[0].id;t.data.find((e=>e.id===C))&&(a=C),1===e||2===e?(F.setFieldsValue({pipelinePluginDetailId:a}),$(i??"",!1)):(F.setFieldsValue({pipelinePluginDetailId:a}),$(t.data[0].script,!0)),z(a)}},K=async(e,i)=>{let t=await j({});if(r(t))return null;V(t.data),e?H(e,i):t.data.length>0&&(F.setFieldsValue({pipelinePluginId:t.data[0].id}),H(t.data[0].id))};return i.useEffect((()=>{if(v.stepComponentOpenType===t.add)F.setFieldsValue({errorStop:1,disabled:0}),K();else{let e=m(v.stepId,v.detail.pipelineStageList);N(e.pipelinePluginId),L(e.pipelinePluginDetailId),D(e),F.setFieldsValue({...e})}return()=>{}}),[]),i.useEffect((()=>(w&&K(w.pipelinePluginId,w.script),()=>{})),[w]),a.jsx("div",{children:a.jsx("div",{className:"mySpace",children:a.jsxs(e,{form:F,autoComplete:"off",disabled:B===t.detail,children:[a.jsxs("div",{className:"myLine",children:[a.jsx(e.Item,{label:"步骤名称",name:"name",rules:[{required:!0}],children:a.jsx(l,{placeholder:"请输入"})}),a.jsx(e.Item,{label:"是否禁用",name:"disabled",rules:[{required:!0}],children:a.jsxs(s.Group,{children:[a.jsx(s,{value:0,children:" 启用 "}),a.jsx(s,{value:1,children:" 禁用 "})]})})]}),a.jsxs("div",{className:"myLine",children:[a.jsx(e.Item,{label:"插件",name:"pipelinePluginId",rules:[{required:!0}],children:a.jsx(n,{options:O,fieldNames:{label:"name",value:"id"},onChange:async e=>{N(parseInt(e));let i=await f({pipelinePluginId:e});if(r(i))return null;if(k(i.data),i.data.length>0){let t=i.data[0].id;i.data.find((e=>e.id===C))&&(t=C),1===e||2===e?(F.setFieldsValue({pipelinePluginDetailId:t}),$("",!1)):(F.setFieldsValue({pipelinePluginDetailId:t}),$(i.data[0].script,!0)),z(t)}}})}),a.jsx(e.Item,{label:"版本",name:"pipelinePluginDetailId",rules:[{required:!0}],children:a.jsx(n,{options:T,fieldNames:{label:"number",value:"id"},onChange:async e=>{let i=T.find((i=>i.id===e));if(1===P||2===P)return $("",!1),void z(e);i&&($(i.script,!0),z(e))}})})]}),a.jsx("div",{className:"myLine",children:a.jsx(e.Item,{label:"构建错误是否退出",name:"errorStop",rules:[{required:!0}],children:a.jsxs(s.Group,{children:[a.jsx(s,{value:1,children:" 退出 "}),a.jsx(s,{value:0,children:" 不退出 "})]})})}),a.jsx(I,{value:G,language:"shell",onChange:J,readOnly:R,reloadValue:M}),a.jsx(b,{title:a.jsx("div",{style:{display:"flex",justifyContent:"space-between"},children:a.jsx("span",{children:"表单"})}),children:a.jsx(e,{form:Y,children:q.map((e=>a.jsx(y,{initFieldBo:e},e.id)))})}),B!==t.detail&&a.jsx(e.Item,{wrapperCol:{offset:12,span:12},style:{marginTop:10},children:a.jsx(d,{type:"primary",htmlType:"submit",onClick:async()=>{if(!(await F.validateFields().catch((()=>!1))))return;const e=await(F?.getFieldsValue());p(e);if(!(await Y.validateFields().catch((()=>!1))))return void u.error("请填写必填项");const i=await(Y?.getFieldsValue());p(e);const a=q.map((e=>{const t={...e};return i[e.id]&&(t.value=i[e.id]),x(t),t})),l=a.find((e=>1===e.notNull&&!e.value&&""===e.value));if(l)u.error(`请填写必填项【${l.name}】`);else{if(v.stepComponentOpenType===t.edit){let i=m(v.stepId,v.detail.pipelineStageList);i.name=e.name,i.disabled=e.disabled,i.pipelinePluginId=e.pipelinePluginId,i.pipelinePluginDetailId=e.pipelinePluginDetailId,i.errorStop=e.errorStop,i.script=G,i.dockerName=e.dockerName,i.paramList=a}if(v.stepComponentOpenType===t.add){let i={...e,id:o(),script:G};i.paramList=a;let t=c(v.stageId,v.detail.pipelineStageList);t.stepList?t.stepList.push(i):t.stepList=[i]}v.setDetailFn(JSON.parse(JSON.stringify(v.detail))),v.setStepComponentOpenTypeFn(t.close)}},children:"确认"})})]})})})};export{v as default};
