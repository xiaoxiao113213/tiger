import{r as e,A as a,_ as t,cq as o,j as s,O as d,B as l,m as r,S as n,I as i,D as c}from"./index-f2321b57.js";import{M as p,n as m}from"./TableNode-896cec27.js";import"./TextNode-196b3caa.js";import{tableSaveNewApi as f,tableAddLineApi as u,tableAllApi as j,tableGetOneApi as x,tableUpdateLocationApi as h,tableDelLineApi as y}from"./api-caa83fd4.js";import"./AddOrUpdateTable-ea6766f9.js";import"./MysqlTypeDic-b22f7053.js";/* empty css                 */import{MaximizeIcon as b}from"./MaximizeIcon-13149026.js";import{MinimizeIcon as C}from"./MinimizeIcon-c212ae8e.js";/* empty css              */import g from"./DefaultTableField-ad3d49ce.js";import k from"./DdlFromDatabase-89ee2c3c.js";import I from"./CompareFromDatabase-df3d26b2.js";import w from"./BatchUpdateColor-3d716a92.js";import{R as B,u as S,a as v,b as T,c as D,i as O,C as F,p as M,B as E,M as P,P as A}from"./index-da2797ee.js";import{T as L}from"./TableOutlined-67e609f9.js";import{D as K}from"./DownOutlined-ffa5ede0.js";import{S as R}from"./SearchOutlined-8e8ecbf1.js";import"./KeyIcon-705f1cf8.js";import"./TableTag-260746a0.js";import"./AddOrUpdateTableField-4bab6dba.js";import"./fieldRow-ff33d2a2.js";import"./DeleteOutlined-10e7bcc5.js";import"./PlusOutlined-0e19b652.js";import"./dicApi-6905b9c5.js";import"./AddOrUpdateIndex-e86b21cf.js";import"./indexRow-1e521494.js";import"./MoreOutlined-609bba84.js";import"./MoreOutlined-49b0b054.js";import"./TableFieldForm-f6535f87.js";import"./core.esm-1c73d5d6.js";import"./api-6611f720.js";import"./api-902e4084.js";import"./index-b1840bba.js";var U=function(o,s){return e.createElement(a,t({},o,{ref:s,icon:L}))};
/**![table](data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIGZpbGw9IiNjYWNhY2EiIHZpZXdCb3g9IjY0IDY0IDg5NiA4OTYiIGZvY3VzYWJsZT0iZmFsc2UiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTkyOCAxNjBIOTZjLTE3LjcgMC0zMiAxNC4zLTMyIDMydjY0MGMwIDE3LjcgMTQuMyAzMiAzMiAzMmg4MzJjMTcuNyAwIDMyLTE0LjMgMzItMzJWMTkyYzAtMTcuNy0xNC4zLTMyLTMyLTMyem0tNDAgMjA4SDY3NlYyMzJoMjEydjEzNnptMCAyMjRINjc2VjQzMmgyMTJ2MTYwek00MTIgNDMyaDIwMHYxNjBINDEyVjQzMnptMjAwLTY0SDQxMlYyMzJoMjAwdjEzNnptLTQ3NiA2NGgyMTJ2MTYwSDEzNlY0MzJ6bTAtMjAwaDIxMnYxMzZIMTM2VjIzMnptMCA0MjRoMjEydjEzNkgxMzZWNjU2em0yNzYgMGgyMDB2MTM2SDQxMlY2NTZ6bTQ3NiAxMzZINjc2VjY1NmgyMTJ2MTM2eiIgLz48L3N2Zz4=) */const q=e.forwardRef(U);var N=function(s,d){return e.createElement(a,t({},s,{ref:d,icon:o}))};
/**![up](data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIGZpbGw9IiNjYWNhY2EiIHZpZXdCb3g9IjY0IDY0IDg5NiA4OTYiIGZvY3VzYWJsZT0iZmFsc2UiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTg5MC41IDc1NS4zTDUzNy45IDI2OS4yYy0xMi44LTE3LjYtMzktMTcuNi01MS43IDBMMTMzLjUgNzU1LjNBOCA4IDAgMDAxNDAgNzY4aDc1YzUuMSAwIDkuOS0yLjUgMTIuOS02LjZMNTEyIDM2OS44bDI4NC4xIDM5MS42YzMgNC4xIDcuOCA2LjYgMTIuOSA2LjZoNzVjNi41IDAgMTAuMy03LjQgNi41LTEyLjd6IiAvPjwvc3ZnPg==) */const z=e.forwardRef(N),V=a=>{const{screenToFlowPosition:t}=S(),o=S(),[B,L]=e.useState([]),[U,N]=e.useState([]),[V,Z]=e.useState(!1),[X,Y]=e.useState(),[_,G]=e.useState(),[W,$]=e.useState(!1),H=e.useRef(null),[J,Q]=e.useState(d.close),[ee,ae]=e.useState(d.close),[te,oe]=e.useState(d.close),[se,de]=e.useState(d.close),le=async()=>{let e=(await j({databaseBoardId:a.databaseBoardId})).data.tableList.map((e=>{let a="table";return"2"===e.shapeType&&(a="text"),{id:e.tableId.toString(),data:{databaseBoardId:e.databaseBoardId,name:e.code,description:e.desc,remarks:e.remarks,columns:e.fieldList.map((e=>({name:e.code,description:e.desc,type:e.type,key:1===e.flagKey}))),schemaColor:e.fillColor??"#91C4F2"},position:{x:e.x,y:e.y},type:a}}));L(e)};e.useEffect((()=>{le()}),[]),e.useEffect((()=>{G(B.map((e=>({label:e.data.name,value:e.id}))))}),[B]);const re=(e,a)=>{e.dataTransfer.setData("application/reactflow",a),e.dataTransfer.effectAllowed="move"},ne=e.useCallback((e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"}),[]),ie=e.useCallback((async e=>{e.preventDefault();const o=e.dataTransfer.getData("application/reactflow");if(void 0===o||!o)return;const s=t({x:e.clientX,y:e.clientY});let d="0";"table"===o?d="0":"text"===o&&(d="2");const l=await f({databaseBoardId:a.databaseBoardId,x:s.x.toString(),y:s.y.toString(),shapeType:d});if(1e3!==l.code)return;const r=l.data,n={id:r.tableId.toString(),type:o,position:s,data:{name:r.code,databaseBoardId:r.databaseBoardId,description:r.desc,remarks:r.remarks,columns:r.fieldList.map((e=>({name:e.code,description:e.desc,type:e.type,key:1===e.flagKey}))),schemaColor:r.fillColor??"#91C4F2"}};L((e=>[...e,n]))}),[t]);e.useEffect((()=>{const e=e=>{if((/Mac|iPod|iPhone|iPad/.test(window.navigator.platform)?e.metaKey:e.ctrlKey)&&"s"===e.key)e.preventDefault()};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}}),[B]);const[ce,pe]=e.useState(""),[me,fe]=e.useState(""),[ue,je]=e.useState(0),[xe,he]=e.useState([]),ye=()=>{je(0),he([]),fe("");let e=B?.filter((e=>e?.data?.name?.includes(ce)));he(e),e?.length>0&&(o.setCenter(e[0].position.x,e[0].position.y),fe(e[0].data.name))},be=e.useCallback((e=>{N((a=>v(e,a))),u({...e,databaseBoardId:a.databaseBoardId})}),[]),Ce=e.useCallback((e=>{L((a=>T(e,a)))}),[]),ge=e.useCallback((e=>{N((a=>D(e,a)))}),[]);return s.jsxs(p.Provider,{value:{reloadTableData:async e=>{const{data:a}=await x({tableId:e});let t="table";"2"===a.shapeType&&(t="text");const o={id:a.tableId.toString(),data:{name:a.code,databaseBoardId:a.databaseBoardId,description:a.desc,remarks:a.remarks,columns:a.fieldList.map((e=>({name:e.code,description:e.desc,type:e.type,key:1===e.flagKey}))),schemaColor:a.fillColor??"#91C4F2"},position:{x:a.x,y:a.y},type:t};L((a=>a.filter((a=>a.id!==e.toString())).concat(o)))},setOpenDrawer:Z,deleteTable:e=>{L((a=>a.filter((a=>a.id!=e))))}},children:[s.jsx("div",{className:"Flow",ref:H,children:s.jsxs(O,{nodes:B,edges:U,onConnect:be,onNodesChange:Ce,onEdgesChange:ge,onNodeDragStop:async(e,t,o)=>{if(V)return;const s=o.map((e=>({x:e.position.x,y:e.position.y,tableId:e.id})));let d={databaseBoardId:a.databaseBoardId,tableList:s};h(d)},onSelectionChange:Y,deleteKeyCode:["Backspace","Delete"],onBeforeDelete:async e=>(N((a=>a.filter((a=>!e.edges.find((e=>e.id===a.id)))))),e.edges.length>0&&e.edges.forEach((e=>{y({...e,databaseBoardId:a.databaseBoardId})})),!1),defaultEdgeOptions:{animated:!0},fitView:!0,snapGrid:[16,16],nodeTypes:m,minZoom:.01,maxZoom:1,preventScrolling:!0,zoomOnScroll:!0,zoomOnPinch:!0,zoomOnDoubleClick:!1,onDrop:ie,onDragOver:ne,children:[s.jsx(F,{showInteractive:!1,children:s.jsxs(M,{onClick:()=>{if(W)document.exitFullscreen().then((function(){$(!1)})).catch((function(e){alert("Can't exit fullscreen")}));else{var e=document.querySelector("body");e&&e.requestFullscreen().then((function(){$(!0)})).catch((function(e){alert("Can't turn on fullscreen")}))}},children:[!W&&s.jsx(b,{}),W&&s.jsx(C,{})]})}),s.jsx(E,{color:"#aaa",gap:16}),s.jsx(P,{pannable:!0,nodeColor:"#151414"}),s.jsxs(A,{position:"top-left",children:[s.jsx(l,{type:"link",onClick:()=>{Q(d.add)},children:"设置默认字段"}),s.jsx(l,{type:"link",onClick:()=>{ae(d.add)},children:"从数据库同步"}),s.jsx(l,{type:"link",onClick:()=>{oe(d.add)},children:"与数据库对比"}),s.jsx(l,{type:"link",onClick:()=>{0!==X?.nodes?.length?de(d.add):r.error("请批量选中节点")},children:"批量改颜色"}),s.jsx(n,{options:_,placeholder:"批量选择表",mode:"multiple",style:{width:300},optionFilterProp:"label",allowClear:!0,showSearch:!0,autoClearSearchValue:!1,onChange:e=>{o.setNodes((a=>a.map((a=>e.includes(a.id)?{...a,selected:!0}:{...a}))))}}),s.jsxs("div",{style:{marginTop:"50px"},children:[s.jsx(l,{type:"link",style:{display:"block"},onClick:()=>{},onDragStart:e=>re(e,"table"),draggable:!0,icon:s.jsx(q,{})}),s.jsx(l,{type:"link",style:{display:"block",marginTop:"10px"},onClick:()=>{},onDragStart:e=>re(e,"text"),draggable:!0,icon:s.jsx("img",{src:"/icons/text.svg",alt:"icon",style:{width:16,height:16}})})]})]}),s.jsxs(A,{position:"top-right",children:[s.jsx("span",{children:me}),s.jsx(i,{style:{width:100,backgroundColor:"rgba(255, 255, 255, 0.5)",marginLeft:15},onChange:e=>{pe(e.target.value)},onPressEnter:ye,allowClear:!0}),s.jsx(l,{shape:"circle",icon:s.jsx(K,{}),onClick:()=>{if(0===xe.length)return;let e;e=ue<=0?xe.length-1:ue-1,je(e),he((e=>(je((a=>(o.setCenter(e[a].position.x,e[a].position.y),fe(e[a].data.name),a))),e)))}}),s.jsx(l,{shape:"circle",icon:s.jsx(z,{}),onClick:()=>{if(0===xe.length)return;let e;e=ue>=xe.length-1?0:ue+1,je(e),he((e=>(je((a=>(o.setCenter(e[a].position.x,e[a].position.y),fe(e[a].data.name),a))),e)))}}),s.jsx(l,{shape:"circle",icon:s.jsx(R,{}),onClick:ye})]})]})}),s.jsx(c,{title:"新表默认字段",open:J!==d.close,width:"80%",destroyOnClose:!0,maskClosable:!1,footer:null,onClose:()=>Q(d.close),children:s.jsx("div",{children:s.jsx(g,{databaseBoardId:a.databaseBoardId,setDefaultFieldModalFn:Q})})},"14"),s.jsx(c,{title:"从数据库同步",open:ee!==d.close,width:"50%",destroyOnClose:!0,maskClosable:!1,footer:null,onClose:()=>ae(d.close),children:s.jsx("div",{children:s.jsx(k,{databaseBoardId:a.databaseBoardId,setAddOrUpdateModalFn:()=>{ae(d.close),le()}})})},"15"),s.jsx(c,{title:"跟数据对比数据",open:te!==d.close,width:"80%",destroyOnClose:!0,maskClosable:!1,footer:null,onClose:()=>oe(d.close),children:s.jsx("div",{children:s.jsx(I,{databaseBoardId:a.databaseBoardId,setAddOrUpdateModalFn:()=>{oe(d.close),le()}})})},"16"),s.jsx(c,{title:"批量改颜色",open:se!==d.close,width:"80%",destroyOnClose:!0,maskClosable:!1,footer:null,onClose:()=>de(d.close),children:s.jsx("div",{children:s.jsx(w,{nodes:X?.nodes,databaseBoardId:a.databaseBoardId,closeComboTagModal:()=>{de(d.close),le()}})})},"16color")]})},Z=e=>s.jsx("div",{style:{width:"95vw",height:"91vh"},children:s.jsx(B,{children:s.jsx(V,{databaseBoardId:e.databaseBoardId,MysqlTypeMap:e.MysqlTypeMap,closeBoardModalFn:e.closeBoardModalFn})})});export{Z as default};
