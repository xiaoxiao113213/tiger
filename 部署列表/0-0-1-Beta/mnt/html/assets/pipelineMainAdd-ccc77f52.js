import{F as e,r as t,O as i,i as s,aj as l,j as r,B as o,I as a,S as n,ab as p,D as m,ak as d,Y as c,al as u,m as j}from"./index-f2321b57.js";import{isStage as f,getStageId as x,isStep as h,getStepId as S,isStart as y,getStage as g,getStageParent as C,getStep as b,getStepStage as N}from"./index-7ad95df9.js";import w from"./stageComponent-8780fca7.js";import I from"./stepComponent-e03081ad.js";import{pipelinePluginDetailGlobalParamApi as L}from"./api-cbd9b73e.js";import{clientToServerValueItem as F,serverToClientValue as k}from"./Bo-900708b2.js";import v from"./PipelineFlow-b9d89384.js";import{PipelineContext as O}from"./context-c3c65fe4.js";import D from"./index-1e1c35a0.js";import T from"./formComponent-e31b7955.js";import{pipelineUpdateApi as E,pipelineSaveApi as P,pipelineGetOneApi as q}from"./pipeline-69e8b66b.js";import{pipelineNodeAllApi as A}from"./api-d0d1aa93.js";import{otherAccountAllApi as B}from"./api-557990cc.js";import{C as J}from"./index-e51db6e5.js";import"./index-b1386cd3.js";import"./submitNowform-f35e2701.js";import"./textSubmit-4229c5b2.js";import"./textAreaSubmit-14d30dcb.js";import"./SelectSubmit-d0c3571a.js";import"./MutSelectSubmit-d4556965.js";import"./DateSubmit-41050df2.js";import"./NumberSubmit-9c6b3724.js";import"./FileUploadSubmit-a4029aca.js";import"./PlusOutlined-0e19b652.js";import"./index-da2797ee.js";/* empty css              */import"./uilts-e16e3ac3.js";import"./StartNode-f0bf4205.js";/* empty css             */import"./dataUtil-d817c03a.js";import"./StageNode-16907dfe.js";import"./StepNode-07191e47.js";import"./CustomEdge-528ca68e.js";import"./FileSubmit-975998bf.js";import"./Title-c989167c.js";import"./Input-f009b856.js";import"./TextArea-47627076.js";import"./customerFieldNew-4b477ff0.js";import"./customerText-29c51ee6.js";import"./customerTextArea-c929063a.js";import"./customerSelect-e147971d.js";import"./MinusCircleOutlined-ede52421.js";import"./MinusCircleOutlined-47af1d51.js";import"./customerMutSelect-b7b09c88.js";import"./CustomerFile-0ba717f3.js";import"./CustomerDate-a09fb913.js";import"./customerNumber-e3e13da1.js";import"./DeleteOutlined-10e7bcc5.js";const M=M=>{const[V]=e.useForm(),[z,R]=t.useState(),[U,$]=t.useState(0),[G,Q]=t.useState(0),[W,Y]=t.useState(i.close),[H,K]=t.useState(i.close),[X,Z]=t.useState(!1),_=s.useRef(null),[ee]=e.useForm(),[te,ie]=t.useState([]),[se,le]=t.useState([]),[re,oe]=t.useState(),[ae,ne]=t.useState(),pe=()=>{M.pipelineId?(async e=>{const t=await q({id:e});if(1e3!==t?.code)return;R({...t.data});const i=t.data.globalParamList??[];i.forEach((e=>{k(e)})),ie(i),V?.setFieldsValue({...t.data}),t.data.permissionList})(M.pipelineId):R({pipelineStageList:[]}),le([{id:1,name:"软件1"},{id:3,name:"软件2"},{id:2,name:"软件3"}]),A({}).then((e=>{oe(e.data)})),B({}).then((e=>{e.data.forEach((e=>e.id=e.id+"")),ne(e.data)}))};if(t.useEffect((()=>{let e=l(z?.pipelineStageList??[]),t=[];return L(e.map((e=>e.pipelinePluginDetailId))).then((e=>{t=t.concat(e.data);let i=[];te&&te.forEach((e=>{if(0===e.pipelinePluginDetailId)i.push(e);else{t.find((t=>t.keyName===e.keyName&&t.pipelinePluginDetailId===e.pipelinePluginDetailId))&&i.push(e)}})),t.forEach((e=>{i.find((t=>t.keyName===e.keyName))||i.push(e)}));let s=i.filter((e=>0!==e.pipelinePluginDetailId));s.push(...i.filter((e=>0===e.pipelinePluginDetailId))),ie(s)})),()=>{}}),[H,z]),t.useEffect((()=>{pe()}),[]),!(z&&re&&ae&&se&&te))return r.jsx("div",{});const me=(e,t)=>{"详情"===e?f(t)?($(parseInt(x(t))),Y(i.detail)):h(t)&&(Q(parseInt(S(t))),K(i.detail)):"修改"===e?f(t)?($(parseInt(x(t))),Y(i.edit)):h(t)&&(Q(parseInt(S(t))),K(i.edit)):"添加子阶段"===e?f(t)?($(parseInt(x(t))),Y(i.add)):h(t)||y(t)&&($(0),Y(i.add)):"添加步骤"===e?f(t)&&($(parseInt(x(t))),K(i.add)):"删除"===e&&(f(t)?R((e=>{let i=parseInt(x(t)),s=g(i,e.pipelineStageList),l=C(i,e.pipelineStageList,null);if(l){const e=l.sonStageList.indexOf(s);-1!==e&&l.sonStageList.splice(e,1)}else{const t=e.pipelineStageList.indexOf(s);-1!==t&&e.pipelineStageList.splice(t,1)}return JSON.parse(JSON.stringify(e))})):h(t)&&R((e=>{let i=parseInt(S(t)),s=b(i,e.pipelineStageList),l=N(i,e.pipelineStageList);const r=l.stepList.indexOf(s);return-1!==r&&l.stepList.splice(r,1),JSON.parse(JSON.stringify(e))})))};return r.jsxs("div",{children:[r.jsx("div",{style:{textAlign:"right"},children:r.jsx(o,{type:"primary",onClick:async()=>{if(!(await V.validateFields().catch((()=>!1))))return;const e=await(V?.getFieldsValue());c(e);const t=te.map((e=>{const t={...e};return F(t),t}));let i;if(z?.id){let s={...z,...e,globalParamList:t};i=await E(u(s))}else{let s={...z,...e,globalParamList:t};i=await P(u(s))}1e3===i?.code&&(j.success(i?.msg),M.reloadTable())},children:"保存"})}),r.jsxs(O.Provider,{value:{nodeClickFn:me,pipelineOpenType:M.openType},children:[r.jsx("div",{className:"mySpace mmm-bgcolor",children:r.jsx(J,{children:r.jsxs(e,{form:V,autoComplete:"off",disabled:M.openType===i.detail,labelCol:{flex:"23%"},wrapperCol:{flex:"77%"},children:[r.jsxs("div",{className:"myLine",children:[r.jsx(e.Item,{label:"流水线名称",name:"name",rules:[{required:!0}],children:r.jsx(a,{placeholder:"请输入",autoComplete:"new-password"})}),r.jsx(e.Item,{label:"所属软件",name:"softIds",rules:[{required:!0}],children:r.jsx(n,{mode:"multiple",options:se,fieldNames:{label:"name",value:"id"}})})]}),r.jsx("div",{className:"myLine",style:{width:"50%"},children:r.jsx(e.Item,{label:"执行机标签",name:"pipelineNodeLabel",rules:[{required:!0}],children:r.jsx(n,{options:re,fieldNames:{label:"label",value:"label"}})})})]})})}),r.jsx(p,{children:"全局参数"}),r.jsx(J,{title:r.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[r.jsx("span",{children:"表单设计"}),r.jsx(o,{type:"link",onClick:()=>Z(!0),children:"设计表单"})]}),children:r.jsx(e,{form:ee,validateTrigger:"false",onValuesChange:(e,t)=>{const i=te;i.forEach((t=>{e.hasOwnProperty(t.id)&&(t.value=e[t.id])})),ie(i)},children:te.map((e=>r.jsx(D,{initFieldBo:e},e.id)))})}),r.jsx(p,{children:"构建视图"}),r.jsx("div",{className:"mmm-bgcolor",children:r.jsx(J,{children:r.jsx("div",{children:r.jsx(v,{detail:z,nodeClickFn:me,openType:M.openType})})})}),r.jsx(m,{title:d(W)+"-阶段",open:W!==i.close,width:"50%",destroyOnClose:!0,maskClosable:!1,onClose:()=>Y(i.close),footer:null,children:r.jsx("div",{children:r.jsx(w,{detail:z,stageComponentOpenType:W,setStageComponentOpenTypeFn:Y,pipelineNodeList:re,id:U,setDetailFn:R})})}),r.jsx(m,{title:d(H)+"-步骤",open:H!==i.close,width:"70%",destroyOnClose:!0,maskClosable:!1,onClose:()=>K(i.close),footer:null,children:r.jsx("div",{children:r.jsx(I,{detail:z,stepComponentOpenType:H,setStepComponentOpenTypeFn:K,pipelineNodeList:re,stepId:G,stageId:U,setDetailFn:R,otherAccountList:ae})})}),r.jsx(m,{title:"表单设计",open:X,onClose:()=>Z(!1),extra:r.jsx(o,{onClick:()=>{const e=_.current?.getFieldList();if(!e)return;e.forEach((t=>{if(""===t.keyName)throw j.error("有字段的唯一标识为空"),new Error("有字段的唯一标识为空");const i=e.filter((e=>e.keyName===t.keyName));if(i.length>1)throw j.error(`有重复的唯一标识【${i[0].keyName}】`),new Error(`有重复的唯一标识【${i[0].keyName}】`)})),ie(e);const t={};e.forEach((e=>{t[e.id]=e.value})),ee.setFieldsValue(t),Z(!1)},type:"primary",children:"确定"}),width:"100%",destroyOnClose:!0,keyboard:!1,children:r.jsx(T,{ref:_,initFormDesign:te,showScope:!1,isEditScope:!1})},"formDesign")]})]})};export{M as default};
