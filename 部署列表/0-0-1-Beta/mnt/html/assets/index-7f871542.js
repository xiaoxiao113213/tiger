import{r as e,A as a,_ as t,cq as o,j as s,O as d,B as l,m as r,S as n,I as i,D as c}from"./index-03adb9ee.js";import{T as p,M as m}from"./TableNode-ef2dbbd8.js";import{MaximizeIcon as f}from"./MaximizeIcon-9d6df152.js";import{MinimizeIcon as u}from"./MinimizeIcon-6ab50c06.js";/* empty css              */import{tableSaveNewApi as j,tableAddLineApi as x,tableAllApi as b,tableGetOneApi as h,tableUpdateLocationApi as y,tableDelLineApi as C}from"./api-324d3d45.js";import g from"./DefaultTableField-65990091.js";import k from"./DdlFromDatabase-f12a052e.js";import I from"./CompareFromDatabase-007ea80a.js";import w from"./BatchUpdateColor-04cf4454.js";import{R as B,u as S,a as v,b as T,c as D,i as O,C as F,p as M,B as E,M as P,P as A}from"./index-19b1aa5f.js";import{TextNode as L}from"./TextNode-fe6bc564.js";import{T as K}from"./TableOutlined-67e609f9.js";import{D as R}from"./DownOutlined-1eda3c64.js";import{S as U}from"./SearchOutlined-f8f28aae.js";import"./KeyIcon-c2d90e8c.js";/* empty css                   */import"./TableTag-b92f49ca.js";import"./AddOrUpdateTable-0b615a69.js";import"./dicApi-3ecc5ba9.js";import"./AddOrUpdateTableField-cb9a4842.js";import"./MysqlTypeDic-d7fdb803.js";/* empty css                 */import"./fieldRow-3a55ec76.js";import"./DeleteOutlined-2f949a39.js";import"./PlusOutlined-b4032aa8.js";import"./AddOrUpdateIndex-015f6e1f.js";import"./indexRow-509acb3b.js";import"./MoreOutlined-d59df38b.js";import"./MoreOutlined-49b0b054.js";import"./TableFieldForm-992330a5.js";import"./core.esm-ac719748.js";import"./api-99b6c63c.js";import"./api-58214640.js";import"./index-d3d70bab.js";var q=function(o,s){return e.createElement(a,t({},o,{ref:s,icon:K}))};
/**![table](data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIGZpbGw9IiNjYWNhY2EiIHZpZXdCb3g9IjY0IDY0IDg5NiA4OTYiIGZvY3VzYWJsZT0iZmFsc2UiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTkyOCAxNjBIOTZjLTE3LjcgMC0zMiAxNC4zLTMyIDMydjY0MGMwIDE3LjcgMTQuMyAzMiAzMiAzMmg4MzJjMTcuNyAwIDMyLTE0LjMgMzItMzJWMTkyYzAtMTcuNy0xNC4zLTMyLTMyLTMyem0tNDAgMjA4SDY3NlYyMzJoMjEydjEzNnptMCAyMjRINjc2VjQzMmgyMTJ2MTYwek00MTIgNDMyaDIwMHYxNjBINDEyVjQzMnptMjAwLTY0SDQxMlYyMzJoMjAwdjEzNnptLTQ3NiA2NGgyMTJ2MTYwSDEzNlY0MzJ6bTAtMjAwaDIxMnYxMzZIMTM2VjIzMnptMCA0MjRoMjEydjEzNkgxMzZWNjU2em0yNzYgMGgyMDB2MTM2SDQxMlY2NTZ6bTQ3NiAxMzZINjc2VjY1NmgyMTJ2MTM2eiIgLz48L3N2Zz4=) */const N=e.forwardRef(q);var z=function(s,d){return e.createElement(a,t({},s,{ref:d,icon:o}))};
/**![up](data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIGZpbGw9IiNjYWNhY2EiIHZpZXdCb3g9IjY0IDY0IDg5NiA4OTYiIGZvY3VzYWJsZT0iZmFsc2UiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTg5MC41IDc1NS4zTDUzNy45IDI2OS4yYy0xMi44LTE3LjYtMzktMTcuNi01MS43IDBMMTMzLjUgNzU1LjNBOCA4IDAgMDAxNDAgNzY4aDc1YzUuMSAwIDkuOS0yLjUgMTIuOS02LjZMNTEyIDM2OS44bDI4NC4xIDM5MS42YzMgNC4xIDcuOCA2LjYgMTIuOSA2LjZoNzVjNi41IDAgMTAuMy03LjQgNi41LTEyLjd6IiAvPjwvc3ZnPg==) */const V=e.forwardRef(z),Z={table:p,text:L},X=a=>{const{screenToFlowPosition:t}=S(),o=S(),[p,B]=e.useState([]),[L,K]=e.useState([]),[q,z]=e.useState(!1),[X,Y]=e.useState(),[_,G]=e.useState(),[W,$]=e.useState(!1),H=e.useRef(null),[J,Q]=e.useState(d.close),[ee,ae]=e.useState(d.close),[te,oe]=e.useState(d.close),[se,de]=e.useState(d.close),le=async()=>{let e=(await b({databaseBoardId:a.databaseBoardId})).data.tableList.map((e=>{let a="table";return"2"===e.shapeType&&(a="text"),{id:e.tableId.toString(),data:{databaseBoardId:e.databaseBoardId,name:e.code,description:e.desc,remarks:e.remarks,columns:e.fieldList.map((e=>({name:e.code,description:e.desc,type:e.type,key:1===e.flagKey}))),schemaColor:e.fillColor??"#91C4F2"},position:{x:e.x,y:e.y},type:a}}));B(e)};e.useEffect((()=>{le()}),[]),e.useEffect((()=>{G(p.map((e=>({label:e.data.name,value:e.id}))))}),[p]);const re=(e,a)=>{e.dataTransfer.setData("application/reactflow",a),e.dataTransfer.effectAllowed="move"},ne=e.useCallback((e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"}),[]),ie=e.useCallback((async e=>{e.preventDefault();const o=e.dataTransfer.getData("application/reactflow");if(void 0===o||!o)return;const s=t({x:e.clientX,y:e.clientY});let d="0";"table"===o?d="0":"text"===o&&(d="2");const l=await j({databaseBoardId:a.databaseBoardId,x:s.x.toString(),y:s.y.toString(),shapeType:d});if(1e3!==l.code)return;const r=l.data,n={id:r.tableId.toString(),type:o,position:s,data:{name:r.code,databaseBoardId:r.databaseBoardId,description:r.desc,remarks:r.remarks,columns:r.fieldList.map((e=>({name:e.code,description:e.desc,type:e.type,key:1===e.flagKey}))),schemaColor:r.fillColor??"#91C4F2"}};B((e=>[...e,n]))}),[t]);e.useEffect((()=>{const e=e=>{if((/Mac|iPod|iPhone|iPad/.test(window.navigator.platform)?e.metaKey:e.ctrlKey)&&"s"===e.key)e.preventDefault()};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}}),[p]);const[ce,pe]=e.useState(""),[me,fe]=e.useState(""),[ue,je]=e.useState(0),[xe,be]=e.useState([]),he=()=>{je(0),be([]),fe("");let e=p?.filter((e=>e?.data?.name?.includes(ce)));be(e),e?.length>0&&(o.setCenter(e[0].position.x,e[0].position.y),fe(e[0].data.name))},ye=e.useCallback((e=>{K((a=>v(e,a))),x({...e,databaseBoardId:a.databaseBoardId})}),[]),Ce=e.useCallback((e=>{B((a=>T(e,a)))}),[]),ge=e.useCallback((e=>{K((a=>D(e,a)))}),[]);return s.jsxs(m.Provider,{value:{reloadTableData:async e=>{const{data:a}=await h({tableId:e});let t="table";"2"===a.shapeType&&(t="text");const o={id:a.tableId.toString(),data:{name:a.code,databaseBoardId:a.databaseBoardId,description:a.desc,remarks:a.remarks,columns:a.fieldList.map((e=>({name:e.code,description:e.desc,type:e.type,key:1===e.flagKey}))),schemaColor:a.fillColor??"#91C4F2"},position:{x:a.x,y:a.y},type:t};B((a=>a.filter((a=>a.id!==e.toString())).concat(o)))},setOpenDrawer:z,deleteTable:e=>{B((a=>a.filter((a=>a.id!=e))))}},children:[s.jsx("div",{className:"Flow",ref:H,children:s.jsxs(O,{nodes:p,edges:L,onConnect:ye,onNodesChange:Ce,onEdgesChange:ge,onNodeDragStop:async(e,t,o)=>{if(q)return;const s=o.map((e=>({x:e.position.x,y:e.position.y,tableId:e.id})));let d={databaseBoardId:a.databaseBoardId,tableList:s};y(d)},onSelectionChange:Y,deleteKeyCode:["Backspace","Delete"],onBeforeDelete:async e=>(K((a=>a.filter((a=>!e.edges.find((e=>e.id===a.id)))))),e.edges.length>0&&e.edges.forEach((e=>{C({...e,databaseBoardId:a.databaseBoardId})})),!1),defaultEdgeOptions:{animated:!0},fitView:!0,snapGrid:[16,16],nodeTypes:Z,minZoom:.01,maxZoom:1,preventScrolling:!0,zoomOnScroll:!0,zoomOnPinch:!0,zoomOnDoubleClick:!1,onDrop:ie,onDragOver:ne,children:[s.jsx(F,{showInteractive:!1,children:s.jsxs(M,{onClick:()=>{if(W)document.exitFullscreen().then((function(){$(!1)})).catch((function(e){alert("Can't exit fullscreen")}));else{var e=document.querySelector("body");e&&e.requestFullscreen().then((function(){$(!0)})).catch((function(e){alert("Can't turn on fullscreen")}))}},children:[!W&&s.jsx(f,{}),W&&s.jsx(u,{})]})}),s.jsx(E,{color:"#aaa",gap:16}),s.jsx(P,{pannable:!0,nodeColor:"#151414"}),s.jsxs(A,{position:"top-left",children:[s.jsx(l,{type:"link",onClick:()=>{Q(d.add)},children:"设置默认字段"}),s.jsx(l,{type:"link",onClick:()=>{ae(d.add)},children:"从数据库同步"}),s.jsx(l,{type:"link",onClick:()=>{oe(d.add)},children:"与数据库对比"}),s.jsx(l,{type:"link",onClick:()=>{0!==X?.nodes?.length?de(d.add):r.error("请批量选中节点")},children:"批量改颜色"}),s.jsx(n,{options:_,placeholder:"批量选择表",mode:"multiple",style:{width:300},optionFilterProp:"label",allowClear:!0,showSearch:!0,autoClearSearchValue:!1,onChange:e=>{o.setNodes((a=>a.map((a=>e.includes(a.id)?{...a,selected:!0}:{...a}))))}}),s.jsxs("div",{style:{marginTop:"50px"},children:[s.jsx(l,{type:"link",style:{display:"block"},onClick:()=>{},onDragStart:e=>re(e,"table"),draggable:!0,icon:s.jsx(N,{})}),s.jsx(l,{type:"link",style:{display:"block",marginTop:"10px"},onClick:()=>{},onDragStart:e=>re(e,"text"),draggable:!0,icon:s.jsx("img",{src:"/icons/text.svg",alt:"icon",style:{width:16,height:16}})})]})]}),s.jsxs(A,{position:"top-right",children:[s.jsx("span",{children:me}),s.jsx(i,{style:{width:100,backgroundColor:"rgba(255, 255, 255, 0.5)",marginLeft:15},onChange:e=>{pe(e.target.value)},onPressEnter:he,allowClear:!0}),s.jsx(l,{shape:"circle",icon:s.jsx(R,{}),onClick:()=>{if(0===xe.length)return;let e;e=ue<=0?xe.length-1:ue-1,je(e),be((e=>(je((a=>(o.setCenter(e[a].position.x,e[a].position.y),fe(e[a].data.name),a))),e)))}}),s.jsx(l,{shape:"circle",icon:s.jsx(V,{}),onClick:()=>{if(0===xe.length)return;let e;e=ue>=xe.length-1?0:ue+1,je(e),be((e=>(je((a=>(o.setCenter(e[a].position.x,e[a].position.y),fe(e[a].data.name),a))),e)))}}),s.jsx(l,{shape:"circle",icon:s.jsx(U,{}),onClick:he})]})]})}),s.jsx(c,{title:"新表默认字段",open:J!==d.close,width:"80%",destroyOnClose:!0,maskClosable:!1,footer:null,onClose:()=>Q(d.close),children:s.jsx("div",{children:s.jsx(g,{databaseBoardId:a.databaseBoardId,setDefaultFieldModalFn:Q})})},"14"),s.jsx(c,{title:"从数据库同步",open:ee!==d.close,width:"50%",destroyOnClose:!0,maskClosable:!1,footer:null,onClose:()=>ae(d.close),children:s.jsx("div",{children:s.jsx(k,{databaseBoardId:a.databaseBoardId,setAddOrUpdateModalFn:()=>{ae(d.close),le()}})})},"15"),s.jsx(c,{title:"跟数据对比数据",open:te!==d.close,width:"80%",destroyOnClose:!0,maskClosable:!1,footer:null,onClose:()=>oe(d.close),children:s.jsx("div",{children:s.jsx(I,{databaseBoardId:a.databaseBoardId,setAddOrUpdateModalFn:()=>{oe(d.close),le()}})})},"16"),s.jsx(c,{title:"批量改颜色",open:se!==d.close,width:"80%",destroyOnClose:!0,maskClosable:!1,footer:null,onClose:()=>de(d.close),children:s.jsx("div",{children:s.jsx(w,{nodes:X?.nodes,databaseBoardId:a.databaseBoardId,closeComboTagModal:()=>{de(d.close),le()}})})},"16color")]})},Y=e=>s.jsx("div",{style:{width:"95vw",height:"91vh"},children:s.jsx(B,{children:s.jsx(X,{databaseBoardId:e.databaseBoardId,MysqlTypeMap:e.MysqlTypeMap,closeBoardModalFn:e.closeBoardModalFn})})});export{Y as default,Z as nodeTypes};
